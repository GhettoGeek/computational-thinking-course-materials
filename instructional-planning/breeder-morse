morseText = ['..','-.',' ','.-',' ','--.','.','-.','.','-','..','-.-.',' ','.-','.-..','--.','---','.-.','..','-','....','--',' ','.-',' ','.--.','---','.--.','..-','.-..','.-','-','..','---','-.',' ','---','..-.',' ','-.-.','.-','-.','-..','..','-..','.-','-','.',' ','...','---','.-..','..-','-','..','---','-.','...',' ','-','---',' ','.-','-.',' ','---','.--.','-','..','--','..','--..','.-','-','..','---','-.',' ','.--.','.-.','---','-...','.-..','.','--',' ','..','...',' ','.','...-','---','.-..','...-','.','-..',' ','-','---','.--','.-','.-.','-..',' ','-...','.','-','-','.','.-.',' ','...','---','.-..','..-','-','..','---','-.','...',' ','.','.-','-.-.','....',' ','-.-.','.-','-.','-..','..','-..','.-','-','.',' ','...','---','.-..','..-','-','..','---','-.',' ','....','.-','...',' ','.-',' ','...','.','-',' ','---','..-.',' ','.--.','.-.','---','.--.','.','.-.','-','..','.','...',' ','.--','....','..','-.-.','....',' ','-.-.','.-','-.',' ','-...','.',' ','--','..-','-','.-','-','.','-..',' ','.-','-.','-..',' ','.-','.-..','-','.','.-.','.','-..',' ','-','.-.','.-','-..','..','-','..','---','-.','.-','.-..','.-..','-.--',' ','...','---','.-..','..-','-','..','---','-.','...',' ','.-','.-.','.',' ','.-.','.','.--.','.-.','.','...','.','-.','-','.','-..',' ','..','-.',' ','-...','..','-.','.-','.-.','-.--',' ','.-','...',' ','...','-','.-.','..','-.','--.','...',' ','---','..-.',' ',' ','...',' ','.-','-.','-..',' ',' ','...',' ','-...','..-','-',' ','---','-','....','.','.-.',' ','.','-.','-.-.','---','-..','..','-.','--.','...',' ','.-','.-.','.',' ','.-','.-..','...','---',' ','.--.','---','...','...','..','-...','.-..','.',' ','-','....','.',' ','.','...-','---','.-..','..-','-','..','---','-.',' ','..-','...','..-','.-','.-..','.-..','-.--',' ','...','-','.-','.-.','-','...',' ','..-.','.-.','---','--',' ','.-',' ','.--.','---','.--.','..-','.-..','.-','-','..','---','-.',' ','---','..-.',' ','.-.','.-','-.','-..','---','--','.-..','-.--',' ','--.','.','-.','.','.-.','.-','-','.','-..',' ','..','-.','-..','..','...-','..','-..','..-','.-','.-..','...',' ','.-','-.','-..',' ','..','...',' ','.-','-.',' ','..','-','.','.-.','.-','-','..','...-','.',' ','.--.','.-.','---','-.-.','.','...','...',' ','.--','..','-','....',' ','-','....','.',' ','.--.','---','.--.','..-','.-..','.-','-','..','---','-.',' ','..','-.',' ','.','.-','-.-.','....',' ','..','-','.','.-.','.-','-','..','---','-.',' ','-.-.','.-','.-..','.-..','.','-..',' ','.-',' ','--.','.','-.','.','.-.','.-','-','..','---','-.',' ','..','-.',' ','.','.-','-.-.','....',' ','--.','.','-.','.','.-.','.-','-','..','---','-.',' ','-','....','.',' ','..-.','..','-','-.','.','...','...',' ','---','..-.',' ','.','...-','.','.-.','-.--',' ','..','-.','-..','..','...-','..','-..','..-','.-','.-..',' ','..','-.',' ','-','....','.',' ','.--.','---','.--.','..-','.-..','.-','-','..','---','-.',' ','..','...',' ','.','...-','.-','.-..','..-','.-','-','.','-..',' ','-','....','.',' ','..-.','..','-','-.','.','...','...',' ','..','...',' ','..-','...','..-','.-','.-..','.-..','-.--',' ','-','....','.',' ','...-','.-','.-..','..-','.',' ','---','..-.',' ','-','....','.',' ','---','-...','.---','.','-.-.','-','..','...-','.',' ','..-.','..-','-.','-.-.','-','..','---','-.',' ','..','-.',' ','-','....','.',' ','---','.--.','-','..','--','..','--..','.-','-','..','---','-.',' ','.--.','.-.','---','-...','.-..','.','--',' ','-...','.','..','-.','--.',' ','...','---','.-..','...-','.','-..',' ','-','....','.',' ','--','---','.-.','.',' ','..-.','..','-',' ','..','-.','-..','..','...-','..','-..','..-','.-','.-..','...',' ','.-','.-.','.',' ','...','-','---','-.-.','....','.-','...','-','..','-.-.','.-','.-..','.-..','-.--',' ','...','.','.-..','.','-.-.','-','.','-..',' ','..-.','.-.','---','--',' ','-','....','.',' ','-.-.','..-','.-.','.-.','.','-.','-',' ','.--.','---','.--.','..-','.-..','.-','-','..','---','-.',' ','.-','-.','-..',' ','.','.-','-.-.','....',' ','..','-.','-..','..','...-','..','-..','..-','.-','.-..','...',' ','--.','.','-.','---','--','.',' ','..','...',' ','--','---','-..','..','..-.','..','.','-..',' ','-','---',' ','..-.','---','.-.','--',' ','.-',' ','-.','.','.--',' ','--.','.','-.','.','.-.','.-','-','..','---','-.',' ','-','....','.',' ','-.','.','.--',' ','--.','.','-.','.','.-.','.-','-','..','---','-.',' ','---','..-.',' ','-.-.','.-','-.','-..','..','-..','.-','-','.',' ','...','---','.-..','..-','-','..','---','-.','...',' ','..','...',' ','-','....','.','-.',' ','..-','...','.','-..',' ','..','-.',' ','-','....','.',' ','-.','.','-..-','-',' ','..','-','.','.-.','.-','-','..','---','-.',' ','---','..-.',' ','-','....','.',' ','.-','.-..','--.','---','.-.','..','-','....','--',' ','-.-.','---','--','--','---','-.','.-..','-.--',' ','-','....','.',' ','.-','.-..','--.','---','.-.','..','-','....','--',' ','-','.','.-.','--','..','-.','.-','-','.','...',' ','.--','....','.','-.',' ','.','..','-','....','.','.-.',' ','.-',' ','--','.-','-..-','..','--','..-','--',' ','-.','..-','--','-...','.','.-.',' ','---','..-.',' ','--.','.','-.','.','.-.','.-','-','..','---','-.','...',' ','....','.-','...',' ','-...','.','.','-.',' ','.--.','.-.','---','-..','..-','-.-.','.','-..',' ','---','.-.',' ','.-',' ','...','.-','-','..','...','..-.','.-','-.-.','-','---','.-.','-.--',' ','..-.','..','-','-.','.','...','...',' ','.-..','.','...-','.','.-..',' ','....','.-','...',' ','-...','.','.','-.',' ','.-.','.','.-','-.-.','....','.','-..',' ','..-.','---','.-.',' ','-','....','.',' ','.--.','---','.--.','..-','.-..','.-','-','..','---','-.',' ','.-',' ','...','-','.-','-.','-..','.-','.-.','-..',' ','.-.','.','.--.','.-.','.','...','.','-.','-','.-','-','..','---','-.',' ','---','..-.',' ','.','.-','-.-.','....',' ','-.-.','.-','-.','-..','..','-..','.-','-','.',' ','...','---','.-..','..-','-','..','---','-.',' ','..','...',' ','.-','...',' ','.-','-.',' ','.-','.-.','.-.','.-','-.--',' ','---','..-.',' ','-...','..','-','...',' ','.-','.-.','.-.','.-','-.--','...',' ','---','..-.',' ','---','-','....','.','.-.',' ','-','-.--','.--.','.','...',' ','.-','-.','-..',' ','...','-','.-.','..-','-.-.','-','..-','.-.','.','...',' ','-.-.','.-','-.',' ','-...','.',' ','..-','...','.','-..',' ','..','-.',' ','.','...','...','.','-.','-','..','.-','.-..','.-..','-.--',' ','-','....','.',' ','...','.-','--','.',' ','.--','.-','-.--',' ','-','....','.',' ','--','.-','..','-.',' ','.--.','.-.','---','.--.','.','.-.','-','-.--',' ','-','....','.-','-',' ','--','.-','-.-','.','...',' ','-','....','.','...','.',' ','--.','.','-.','.','-','..','-.-.',' ','.-.','.','.--.','.-.','.','...','.','-.','-','.-','-','..','---','-.','...',' ','-.-.','---','-.','...-','.','-.','..','.','-.','-',' ','..','...',' ','-','....','.-','-',' ','-','....','.','..','.-.',' ','.--.','.-','.-.','-','...',' ','.-','.-.','.',' ','.','.-','...','..','.-..','-.--',' ','.-','.-..','..','--.','-.','.','-..',' ','-..','..-','.',' ','-','---',' ','-','....','.','..','.-.',' ','..-.','..','-..-','.','-..',' ','...','..','--..','.',' ','.--','....','..','-.-.','....',' ','..-.','.-','-.-.','..','.-..','..','-','.-','-','.','...',' ','...','..','--','.--.','.-..','.',' ','-.-.','.-.','---','...','...','---','...-','.','.-.',' ','---','.--.','.','.-.','.-','-','..','---','-.','...',' ','...-','.-','.-.','..','.-','-...','.-..','.',' ','.-..','.','-.','--.','-','....',' ','.-.','.','.--.','.-.','.','...','.','-.','-','.-','-','..','---','-.','...',' ','--','.-','-.--',' ','.-','.-..','...','---',' ','-...','.',' ','..-','...','.','-..',' ','-...','..-','-',' ','-.-.','.-.','---','...','...','---','...-','.','.-.',' ','..','--','.--.','.-..','.','--','.','-.','-','.-','-','..','---','-.',' ','..','...',' ','--','---','.-.','.',' ','-.-.','---','--','.--.','.-..','.','-..-',' ','..','-.',' ','-','....','..','...',' ','-.-.','.-','...','.',' ','-','.-.','.','.',' ','.-..','..','-.-','.',' ','.-.','.','.--.','.-.','.','...','.','-.','-','.-','-','..','---','-.','...',' ','.-','.-.','.',' ','.','-..-','.--.','.-..','---','.-.','.','-..',' ','..','-.',' ','--.','.','-.','.','-','..','-.-.',' ','.--.','.-.','---','--.','.-.','.-','--','--','..','-.','--.',' ','.-','-.','-..',' ','--.','.-.','.-','.--.','....',' ','..-.','---','.-.','--',' ','.-.','.','.--.','.-.','.','...','.','-.','-','.-','-','..','---','-.','...',' ','.-','.-.','.',' ','.','-..-','.--.','.-..','---','.-.','.','-..',' ','..','-.',' ','.','...-','---','.-..','..-','-','..','---','-.','.-','.-.','-.--',' ','.--.','.-.','---','--.','.-.','.-','--','--','..','-.','--.',' ','.-',' ','--','..','-..-',' ','---','..-.',' ','-...','---','-','....',' ','.-..','..','-.','.','.-','.-.',' ','-.-.','....','.-.','---','--','---','...','---','--','.','...',' ','.-','-.','-..',' ','-','.-.','.','.','...',' ','..','...',' ','.','-..-','.--.','.-..','---','.-.','.','-..',' ','..','-.',' ','--.','.','-.','.',' ','.','-..-','.--.','.-.','.','...','...','..','---','-.',' ','.--.','.-.','---','--.','.-.','.-','--','--','..','-.','--.',' ','---','-.','-.-.','.',' ','-','....','.',' ','--.','.','-.','.','-','..','-.-.',' ','.-.','.','.--.','.-.','.','...','.','-.','-','.-','-','..','---','-.',' ','.-','-.','-..',' ','-','....','.',' ','..-.','..','-','-.','.','...','...',' ','..-.','..-','-.','-.-.','-','..','---','-.',' ','.-','.-.','.',' ','-..','.','..-.','..','-.','.','-..',' ','.-',' ','--.','.-',' ','.--.','.-.','---','-.-.','.','.','-..','...',' ','-','---',' ','..','-.','..','-','..','.-','.-..','..','--..','.',' ','.-',' ','.--.','---','.--.','..-','.-..','.-','-','..','---','-.',' ','---','..-.',' ','...','---','.-..','..-','-','..','---','-.','...',' ','.-','-.','-..',' ','-','....','.','-.',' ','-','---',' ','..','--','.--.','.-.','---','...-','.',' ','..','-',' ','-','....','.-.','---','..-','--.','....',' ','.-.','.','.--.','.','-','..','-','..','...-','.',' ','.-','.--.','.--.','.-..','..','-.-.','.-','-','..','---','-.',' ','---','..-.',' ','-','....','.',' ','--','..-','-','.-','-','..','---','-.',' ',' ','-.-.','.-.','---','...','...','---','...-','.','.-.',' ','..','-.','...-','.','.-.','...','..','---','-.',' ','.-','-.','-..',' ','...','.','.-..','.','-.-.','-','..','---','-.',' ','---','.--.','.','.-.','.-','-','---','.-.','...']

genomeSize = 8
populationSize = 18
mutationRate = .3

turtle.remove()
grid = table 3, 3
solution = table 1,genomeSize

RandomGenome = () ->
  genome = (i for i in [0..genomeSize-1])
  shuffle = (genome.sort (a, b) -> 0.5 - Math.random())
  return genome
    
Mutate = (originalGenome) ->
  genome = (i for i in originalGenome)
  for j in [0..genomeSize-1]
    if (random 100)/100 < mutationRate
      randomIndex = random genomeSize
      temp = genome[randomIndex]
      genome[randomIndex] = genome[j]
      genome[j] = temp
  return genome
  
MateAndReplace = (workingSet, indexA, indexB) ->
  parentA = workingSet[indexA]
  parentB = workingSet[indexB]

  parentA.fitness++
  parentB.fitness++

  fitSort = workingSet.sort (a, b) -> b.fitness - a.fitness
 
  leastFit1 = fitSort[fitSort.length-1]
  leastFit2 = fitSort[fitSort.length-2]
  leastFit1.genome = Mutate( parentA.genome )
  leastFit2.genome = Mutate( parentB.genome )
  leastFit1.fitness = parentA.fitness - 1
  leastFit2.fitness = parentB.fitness - 1

#Could make this fitness contingent
GetWorkingSet = (population) ->
  shuffle = (population.sort (a, b) -> 0.5 - Math.random())
  return shuffle[0..8]

GetDecoder = (member) ->
  alphabet = 'abcdefghijklmnopqrstuvwxyz '
  morseDecoder = {'.-' : 0, '-...' : 1, '-.-.' : 2, '-..' : 3, '.' : 4, '..-.' : 5, '--.' : 6, '....' : 7, '..' : 8, '.---' : 9, '-.-' : 10, '.-..' : 11, '--' : 12, '-.' : 13, '---' : 14, '.--.' : 15, '--.-' : 16, '.-.' : 17, '...' : 18, '-' : 19, '..-' : 20, '...-' : 21, '.--' : 22, '-..-' : 23, '-.--' : 24, '--..' : 25, ' ' : 26}
  for k,v of morseDecoder
    if v < genomeSize
      letterPosition = member.genome[v]
      morseDecoder[k] = alphabet[letterPosition]
    else
      morseDecoder[k] = alphabet[v]
  return morseDecoder
  
GetPhenotype = (member,start,length) ->
  morseDecoder = GetDecoder(member)
  decodedLetters = ( morseDecoder[ morseText[i] ] for i in [start..start+length] )
  decodedText = decodedLetters.join('')
  p = write decodedText
  p.css {width: 200} 
  return p
  
UpdateBest = (population) ->
  bestScore = 0
  bestMember = null
  for m,i in population
    score = 0
    for g,i in m.genome
      if g is i
        score++
    if score > bestScore
      bestScore = score
      bestMember = m
  alphabet = 'abcdefghijklmnopqrstuvwxyz'
  for g,i in bestMember.genome
    p = write alphabet[i]
    solution.cell().eq(i).html p
    if g is i
      solution.cell().eq(i).css {background : 'green'}
    else 
      solution.cell().eq(i).css {background : 'white'}

UpdateGrid = (workingSet) ->
  textLength = 30
  textStart = random morseText.length-textLength
  for member,i in workingSet
    grid.cell().eq(i).html GetPhenotype(member,textStart,textLength)
    grid.cell().eq(i).css {background : 'white', 'font-size': '24px'}
  UpdateBest population
  
population = ( fitness: 0, genome: RandomGenome() for [1..populationSize])
workingSet = GetWorkingSet(population)
UpdateGrid(workingSet)

selections = []
grid.cell().click ->
  selection = grid.cell().index this
  selections.push(selection)
  grid.cell().eq(selection).css {background : 'orange'}
  if selections.length is 2
    MateAndReplace( workingSet, selections[0], selections[1] )
    workingSet = GetWorkingSet(population)
    UpdateGrid(workingSet)
    selections = []

